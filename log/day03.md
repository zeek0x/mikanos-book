# 3.1 QEMU モニタ

- info registers コマンド: CPU の各レジスタの現在の値を表示する

```console
(qemu) info registers

CPU#0
RAX=0000000000000000 RBX=0000000000000000 RCX=000000000000000d RDX=0000000000000015
RSI=000000003fec93d0 RDI=000000003e78d1c0 RBP=000000003e78d1c8 RSP=000000003feaca80
R8 =00000000000000af R9 =0000000000000018 R10=0000000000000050 R11=0000000000000000
R12=000000003f21b818 R13=000000003f21bf18 R14=8000000000000002 R15=0000000000000131
RIP=000000003e67a012 RFL=00000206 [-----P-] CPL=0 II=0 A20=1 SMM=0 HLT=0
ES =0030 0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
CS =0038 0000000000000000 ffffffff 00af9a00 DPL=0 CS64 [-R-]
SS =0030 0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
DS =0030 0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
FS =0030 0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
GS =0030 0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
LDT=0000 0000000000000000 0000ffff 00008200 DPL=0 LDT
TR =0000 0000000000000000 0000ffff 00008b00 DPL=0 TSS64-busy
GDT=     000000003fbee698 00000047
IDT=     000000003f306018 00000fff
CR0=80010033 CR2=0000000000000000 CR3=000000003fc01000 CR4=00000668
DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000
DR6=00000000ffff0ff0 DR7=0000000000000400
EFER=0000000000000500
FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80
FPR0=0000000000000000 0000 FPR1=0000000000000000 0000
FPR2=0000000000000000 0000 FPR3=0000000000000000 0000
FPR4=0000000000000000 0000 FPR5=0000000000000000 0000
FPR6=0000000000000000 0000 FPR7=0000000000000000 0000
XMM00=0000000000000000 0000000000000000 XMM01=0000000000000000 0000000000000000
XMM02=0000000000000000 0000000000000000 XMM03=0000000000000000 0000000000000000
XMM04=0000000000000000 0000000000000000 XMM05=0000000000000000 0000000000000000
XMM06=0000000000000000 0000000000000000 XMM07=0000000000000000 0000000000000000
XMM08=0000000000000000 0000000000000000 XMM09=0000000000000000 0000000000000000
XMM10=0000000000000000 0000000000000000 XMM11=0000000000000000 0000000000000000
XMM12=0000000000000000 0000000000000000 XMM13=0000000000000000 0000000000000000
XMM14=0000000000000000 0000000000000000 XMM15=0000000000000000 0000000000000000
```

> [!TIP]
> RIP レジスタはデバッグ時によく使われるレジスタで、次に実行する命令のアドレスが格納される

- x コマンド: 指定アドレスの値を表示する

```console
x /fmt addr
```

- fmt: [個数][フォーマット][サイズ]
  - 個数: 何個分表示するか
  - フォーマット
    - x: 16進数
    - d: 10進数
    - i: 機械語命令の逆アセンブル
  - サイズ: バイト数の単位
    - b: 1 バイト
    - h: 2 バイト
    - w: 4 バイト
    - g: 8 バイト

RIP レジスタを覗いてみる。

```console
(qemu) x /4xb 0x3e67a012
000000003e67a012: 0xeb 0xfe 0xaf 0xaf
```

機械語命令っぽいとのことで2命令分を逆アセンブル表示する。

```console
(qemu) x /2i 0x3e67a012
0x3e67a012: Asm output not supported on this arch
```

アーキテクチャが対応していない :thiking_face:

```console
$ uname -m
x86_64
```

hm... objdump でなんとか調べてみよう

```console
$ echo -ne '\xeb\xfe\xaf\xaf' > bytes.bin
$ objdump -D -b binary -m i386:x86-64 bytes.bin

bytes.bin:     file format binary


Disassembly of section .data:

0000000000000000 <.data>:
   0:   eb fe                   jmp    0x0
   2:   af                      scas   %es:(%rdi),%eax
   3:   af                      scas   %es:(%rdi),%eax
```

> [!TIP]
> 書籍とアドレスが違うのはなぜ？
> jmp のアドレスが相対値であり、表示のタイミングで絶対値に変換しているから
